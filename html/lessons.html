<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L·ªô Tr√¨nh H·ªçc T·∫≠p Ng√¥n Ng·ªØ L·∫≠p Tr√¨nh Chuy√™n Nghi·ªáp</title>
<link rel="stylesheet" href="../css/lessons.css">

</head>
<body>
  <div id="container">
    <h1>T·∫°o L·ªô Tr√¨nh H·ªçc T·∫≠p C√° Nh√¢n</h1>

    <p><strong>ƒêi·ªÉm b√†i test ƒë·∫ßu v√†o c·ªßa b·∫°n:</strong> <span id="scoreDisplay">ƒêang t·∫£i...</span></p>

    <label for="languageSelect">Ch·ªçn Ng√¥n Ng·ªØ L·∫≠p Tr√¨nh:</label>
    <select id="languageSelect" onchange="updateSelectedLanguage()">
      <option value="">-- Ch·ªçn ng√¥n ng·ªØ --</option>
      <option value="Python">Python</option>
      <option value="JavaScript">JavaScript</option>
      <option value="C++">C++</option>
      <option value="Java">Java</option>
      <option value="Go">Go</option>
      <option value="Ruby">Ruby</option>
    </select>

    <button onclick="generateOrLoadRoadmap()">T·∫°o / T·∫£i L·ªô Tr√¨nh H·ªçc T·∫≠p</button>

    <div class="loading-spinner" id="loadingSpinner">
      ƒêang t·∫°o l·ªô tr√¨nh...
    </div>

    <div id="result">
      <p style="text-align: center; color: #777;">L·ªô tr√¨nh h·ªçc t·∫≠p s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi b·∫°n ch·ªçn ng√¥n ng·ªØ v√† nh·∫•p v√†o n√∫t "T·∫°o / T·∫£i L·ªô Tr√¨nh H·ªçc T·∫≠p".</p>
    </div>
  </div>

  <div id="lessonModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle"></h2>
      <div id="modalContent"></div>
    </div>
  </div>
<!-- N√∫t ƒëi·ªÅu h∆∞·ªõng -->
<a href="/index.html" class="fixed-button left-button">üè† Trang ch·ªß</a>
<a href="code.html" class="fixed-button right-button">üíª Trang Code</a>

  <script>
// Bi·∫øn l∆∞u tr·ªØ l·ªô tr√¨nh ƒë√£ t·∫£i
let currentRoadmap = null;

// Hi·ªÉn th·ªã ƒëi·ªÉm l√∫c ƒë·∫ßu t·∫£i trang
document.addEventListener('DOMContentLoaded', () => {
    const initialScore = localStorage.getItem('quizScore');
    document.getElementById('scoreDisplay').textContent = initialScore ? `${initialScore} ƒëi·ªÉm` : 'Ch∆∞a c√≥ ƒëi·ªÉm';

    // Kh√¥i ph·ª•c ng√¥n ng·ªØ ƒë√£ ch·ªçn t·ª´ localStorage (n·∫øu c√≥)
    const savedLanguage = localStorage.getItem('selectedLanguage');
    if (savedLanguage) {
        document.getElementById('languageSelect').value = savedLanguage;
        // T·∫£i l·ªô tr√¨nh n·∫øu c√≥ s·∫µn cho ng√¥n ng·ªØ ƒë√£ ch·ªçn
        loadRoadmapFromLocalStorage(savedLanguage);
    }
});

function updateSelectedLanguage() {
    const lang = document.getElementById('languageSelect').value;
    localStorage.setItem('selectedLanguage', lang);
    // Khi thay ƒë·ªïi ng√¥n ng·ªØ, th·ª≠ t·∫£i l·ªô tr√¨nh ƒë√£ l∆∞u cho ng√¥n ng·ªØ ƒë√≥
    loadRoadmapFromLocalStorage(lang);
}

function loadRoadmapFromLocalStorage(language) {
    const resultDiv = document.getElementById('result');
    const storedRoadmap = localStorage.getItem(`roadmap_${language}`);
    if (storedRoadmap) {
        try {
            const roadmapData = JSON.parse(storedRoadmap);
            currentRoadmap = roadmapData; // L∆∞u v√†o bi·∫øn to√†n c·ª•c
            displayRoadmap(roadmapData);
            console.log(`ƒê√£ t·∫£i l·ªô tr√¨nh ${language} t·ª´ localStorage.`);
            return true;
        } catch (e) {
            console.error(`L·ªói khi parse l·ªô tr√¨nh ${language} t·ª´ localStorage:`, e);
            resultDiv.innerHTML = `<p class="error-message">L·ªói khi t·∫£i l·ªô tr√¨nh ƒë√£ l∆∞u cho ${language}. Vui l√≤ng th·ª≠ t·∫°o l·∫°i.</p>`;
            return false;
        }
    } else {
        resultDiv.innerHTML = `<p style="text-align: center; color: #777;">Ch∆∞a c√≥ l·ªô tr√¨nh n√†o ƒë∆∞·ª£c l∆∞u cho ng√¥n ng·ªØ ${language}. Nh·∫•n "T·∫°o / T·∫£i L·ªô Tr√¨nh H·ªçc T·∫≠p" ƒë·ªÉ t·∫°o m·ªõi.</p>`;
        currentRoadmap = null;
        return false;
    }
}

async function generateOrLoadRoadmap() {
    const lang = document.getElementById('languageSelect').value;
    if (!lang) {
        alert("Vui l√≤ng ch·ªçn m·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh!");
        return;
    }

    // N·∫øu c√≥ l·ªô tr√¨nh ƒë√£ l∆∞u cho ng√¥n ng·ªØ n√†y, hi·ªÉn th·ªã n√≥
    if (loadRoadmapFromLocalStorage(lang)) {
        return;
    }

    // N·∫øu kh√¥ng c√≥, th√¨ t·∫°o m·ªõi
    await generatePrompt();
}

async function generatePrompt() {
    const score = localStorage.getItem('quizScore');
    if (!score) {
        alert("Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm b√†i test ƒë·∫ßu v√†o. Vui l√≤ng ho√†n th√†nh b√†i ki·ªÉm tra tr∆∞·ªõc.");
        return;
    }

    const lang = document.getElementById('languageSelect').value;
    if (!lang) {
        alert("Vui l√≤ng ch·ªçn m·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh ƒë·ªÉ t·∫°o l·ªô tr√¨nh.");
        return;
    }

    const resultDiv = document.getElementById('result');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // X√≥a n·ªôi dung c≈© v√† hi·ªÉn th·ªã spinner
    resultDiv.innerHTML = '';
    loadingSpinner.style.display = 'block';

    // T·∫°o prompt y√™u c·∫ßu l·ªô tr√¨nh h·ªçc t·∫≠p chi ti·∫øt
    const prompt = `T·ª´ k·∫øt qu·∫£ b√†i test ƒë·∫ßu v√†o l√† ${score} ƒëi·ªÉm, b·∫°n h√£y t·∫°o ra cho t√¥i m·ªôt l·ªô tr√¨nh h·ªçc ng√¥n ng·ªØ l·∫≠p tr√¨nh ${lang}. L·ªô tr√¨nh n√†y ph·∫£i d·∫°y c·ª±c k·ª≥ **k·ªπ l∆∞·ª°ng v√† chi ti·∫øt** t·ª´ng n·ªôi dung, ki·∫øn th·ª©c c·ªßa m·ªói b√†i h·ªçc. M·ªói b√†i h·ªçc c·∫ßn **gi·∫£i th√≠ch c·∫∑n k·∫Ω c√°c ƒë·ªãnh nghƒ©a, quy t·∫Øc, c√∫ ph√°p, v√≠ d·ª• minh h·ªça v√† tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng th·ª±c t·∫ø**. ƒê·∫∑c bi·ªát, h√£y ƒëi s√¢u v√†o c√°c kh√°i ni·ªám c·ªët l√µi nh∆∞ c·∫•u tr√∫c d·ªØ li·ªáu, thu·∫≠t to√°n, l·∫≠p tr√¨nh h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng, x·ª≠ l√Ω ngo·∫°i l·ªá, v√† l√†m vi·ªác v·ªõi file, m·∫°ng. ƒê·ª´ng ƒë∆∞a ra nh·ªØng b√†i h·ªçc t√¥i ƒë√£ bi·∫øt ƒë∆∞·ª£c th√¥ng qua b√†i test (gi·∫£ ƒë·ªãnh ${score} ƒëi·ªÉm th·ªÉ hi·ªán ki·∫øn th·ª©c c∆° b·∫£n c·ªßa t√¥i).
K·∫øt qu·∫£ tr·∫£ v·ªÅ ph·∫£i l√† 1 l·ªô tr√¨nh h·ªçc t·∫≠p ng√¥n ng·ªØ l·∫≠p tr√¨nh ${lang} d·∫°ng JSON thu·∫ßn t√∫y, kh√¥ng c√≥ b·∫•t k·ª≥ k√Ω t·ª± n√†o kh√°c ngo√†i JSON. C·∫•u tr√∫c JSON nh∆∞ sau:
{
  "point": "${score}",
  "lang": "${lang}",
  "lotrinh": [
    ["B√†i 1: T√™n n·ªôi dung chi ti·∫øt", "ƒê∆∞a ra nh·ªØng ki·∫øn th·ª©c, b√†i t·∫≠p kinh ƒëi·ªÉn v·ªÅ ƒë∆°n v·ªã b√†i h·ªçc ƒë√≥. H√£y chia nh·ªè c√°c ƒë·ªãnh nghƒ©a, quy t·∫Øc, c√∫ ph√°p, ƒë∆∞a ra v√≠ d·ª• minh h·ªça, v√† gi·∫£i th√≠ch r√µ r√†ng t·ª´ng ph·∫ßn. ƒê·∫£m b·∫£o n·ªôi dung b√†i h·ªçc ƒê·ª¶ D√ÄI v√† ƒê·∫¶Y ƒê·ª¶ ki·∫øn th·ª©c c·∫ßn thi·∫øt ƒë·ªÉ ng∆∞·ªùi h·ªçc hi·ªÉu s√¢u. M·ªói b√†i h·ªçc ph·∫£i th·∫≠t chi ti·∫øt v√† ƒë·ªß l∆∞·ª£ng b√†i t·∫≠p c·∫ßn thi·∫øt cho ng∆∞·ªùi h·ªçc c√≥ th·ªÉ n·∫Øm b·∫Øt ƒë∆∞·ª£c to√†n b·ªô n·ªôi dung b√†i h·ªçc. T·ªïng s·ªë b√†i h·ªçc ph·∫£i tr√™n 20 b√†i."],
    // ... (Th√™m c√°c b√†i h·ªçc ti·∫øp theo, m·ªói b√†i ƒë·ªÅu b·∫Øt bu·ªôc ph·∫£i bao g·ªìm b√†i t·∫≠p, v√† ƒë∆∞·ª£c chia b·ªë c·ª•c r√µ r√†ng, d·ªÖ nh√¨n)
  ]
}
H√£y ƒë·∫£m b·∫£o r·∫±ng ph·∫£n h·ªìi ch·ªâ bao g·ªìm duy nh·∫•t kh·ªëi JSON, kh√¥ng c√≥ b·∫•t k·ª≥ vƒÉn b·∫£n, d·∫•u backtick, ho·∫∑c gi·∫£i th√≠ch n√†o kh√°c b√™n ngo√†i JSON, n·ªôi dung b√†i h·ªçc ph·∫£i ƒë∆∞·ª£c tr√¨nh b√†y m·ªôt c√°ch khoa h·ªçc d·ªÖ nh√¨n, ƒë·ªß b√†i t·∫≠p c·∫ßn thi·∫øt ·ªü ph√≠a sau v√† kh√¥ng ch·ª©a nh·ªØng k√≠ t·ª± kh√¥ng li√™n quan.`;

    const encodedPrompt = encodeURIComponent(prompt);
    const url = `https://code.techmax.site/system/getai.php?prombt=${encodedPrompt}`;

    let rawData = ''; // Khai b√°o bi·∫øn ƒë·ªÉ l∆∞u d·ªØ li·ªáu th√¥
    let cleanedData = ''; // Khai b√°o bi·∫øn ƒë·ªÉ l∆∞u d·ªØ li·ªáu ƒë√£ l√†m s·∫°ch

    try {
        const res = await fetch(url);
        if (!res.ok) {
            throw new Error(`L·ªói HTTP: ${res.status}. Vui l√≤ng ki·ªÉm tra API ho·∫∑c k·∫øt n·ªëi m·∫°ng.`);
        }
        rawData = await res.text(); // G√°n d·ªØ li·ªáu th√¥

        // ·∫®n spinner ngay khi nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu
        loadingSpinner.style.display = 'none';

        // S·ª¨ D·ª§NG H√ÄM CLEANJSONSTRING M·ªöI NH·∫§T
        cleanedData = cleanJsonString(rawData);

        // Debug: In ra d·ªØ li·ªáu ƒë√£ l√†m s·∫°ch tr∆∞·ªõc khi parse
        console.log("D·ªØ li·ªáu th√¥ nh·∫≠n ƒë∆∞·ª£c t·ª´ API:", rawData);
        console.log("D·ªØ li·ªáu ƒë√£ l√†m s·∫°ch tr∆∞·ªõc khi parse:", cleanedData);

        // Ki·ªÉm tra n·∫øu cleanedData r·ªóng sau khi l√†m s·∫°ch, c√≥ nghƒ©a l√† kh√¥ng t√¨m th·∫•y JSON h·ª£p l·ªá
        if (!cleanedData) {
            throw new Error("Kh√¥ng t√¨m th·∫•y JSON h·ª£p l·ªá trong ph·∫£n h·ªìi t·ª´ API.");
        }

        const roadmapData = JSON.parse(cleanedData); // Th·ª≠ ph√¢n t√≠ch JSON ƒë√£ l√†m s·∫°ch

        if (roadmapData && Array.isArray(roadmapData.lotrinh) && roadmapData.lotrinh.length > 0) {
            currentRoadmap = roadmapData; // L∆∞u v√†o bi·∫øn to√†n c·ª•c
            // L∆∞u l·ªô tr√¨nh v√†o localStorage v·ªõi kh√≥a ri√™ng cho t·ª´ng ng√¥n ng·ªØ
            localStorage.setItem(`roadmap_${lang}`, JSON.stringify(roadmapData));
            displayRoadmap(roadmapData);
        } else {
            resultDiv.innerHTML = '<p class="error-message">Kh√¥ng c√≥ l·ªô tr√¨nh h·ªçc t·∫≠p n√†o ƒë∆∞·ª£c t·∫°o ho·∫∑c d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.</p>';
        }
    } catch (error) {
        // ·∫®n spinner trong tr∆∞·ªùng h·ª£p l·ªói
        loadingSpinner.style.display = 'none';

        let errorMessage = `<p class="error-message">ƒê√£ x·∫£y ra l·ªói: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.</p>`;
        if (error instanceof SyntaxError) {
            // L·ªói ph√¢n t√≠ch c√∫ ph√°p JSON
            errorMessage += `<p class="sub-error-message">C√≥ v·∫ª nh∆∞ ƒë·ªãnh d·∫°ng JSON nh·∫≠n ƒë∆∞·ª£c kh√¥ng ƒë√∫ng.</p>`;
            // Hi·ªÉn th·ªã d·ªØ li·ªáu th√¥ v√† d·ªØ li·ªáu ƒë√£ l√†m s·∫°ch ƒë·ªÉ debug
            errorMessage += `<p class="sub-error-message">D·ªØ li·ªáu th√¥ t·ª´ API: <pre class="raw-data">${escapeHtml(rawData)}</pre></p>`;
            errorMessage += `<p class="sub-error-message">D·ªØ li·ªáu ƒë√£ l√†m s·∫°ch (g√¢y l·ªói parse): <pre class="raw-data">${escapeHtml(cleanedData)}</pre></p>`;
        } else if (error.message.includes('HTTP')) {
            errorMessage += `<p class="sub-error-message">Ki·ªÉm tra k·∫øt n·ªëi internet ho·∫∑c API c·ªßa b·∫°n.</p>`;
        }
        resultDiv.innerHTML = errorMessage;
        console.error("L·ªói khi t·∫°o l·ªô tr√¨nh:", error);
    }
}

function displayRoadmap(roadmapData) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = ''; // X√≥a n·ªôi dung c≈©

    const langName = roadmapData.lang || 'Ng√¥n ng·ªØ l·∫≠p tr√¨nh';
    const scoreValue = roadmapData.point || 'Kh√¥ng x√°c ƒë·ªãnh';

    const heading = document.createElement('h2');
    heading.className = 'roadmap-heading';
    heading.textContent = `L·ªô Tr√¨nh H·ªçc T·∫≠p ${langName} c·ªßa b·∫°n`;
    resultDiv.appendChild(heading);

    roadmapData.lotrinh.forEach((lesson) => {
        const lessonContainer = document.createElement('div');
        lessonContainer.className = 'lesson-container';
        lessonContainer.tabIndex = 0; // ƒê·ªÉ c√≥ th·ªÉ focus b·∫±ng b√†n ph√≠m
        lessonContainer.setAttribute('role', 'button'); // ƒê√°nh d·∫•u l√† m·ªôt n√∫t c√≥ th·ªÉ click
        lessonContainer.setAttribute('aria-label', `Xem chi ti·∫øt b√†i h·ªçc: ${lesson[0]}`);

        // Th√™m s·ª± ki·ªán click ƒë·ªÉ m·ªü modal
        lessonContainer.onclick = () => openLessonModal(lesson[0], lesson[1]);
        lessonContainer.onkeydown = (event) => { // H·ªó tr·ª£ truy c·∫≠p b·∫±ng b√†n ph√≠m (Enter/Space)
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault(); // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa ph√≠m Space (cu·ªôn trang)
                openLessonModal(lesson[0], lesson[1]);
            }
        };

        const lessonTitle = document.createElement('h3');
        lessonTitle.className = 'lesson-title';
        lessonTitle.textContent = lesson[0];

        const lessonContentPreview = document.createElement('p');
        lessonContentPreview.className = 'lesson-preview';
        const previewLength = 250; // TƒÉng s·ªë k√Ω t·ª± xem tr∆∞·ªõc ƒë·ªÉ n·ªôi dung c√≥ √Ω nghƒ©a h∆°n
        let previewText = lesson[1];
        if (lesson[1].length > previewLength) {
            // C·∫Øt ·ªü cu·ªëi t·ª´ g·∫ßn nh·∫•t ƒë·ªÉ tr√°nh c·∫Øt c·ª•t gi·ªØa ch·ª´ng
            const lastSpaceIndex = lesson[1].lastIndexOf(' ', previewLength);
            previewText = lesson[1].substring(0, lastSpaceIndex !== -1 ? lastSpaceIndex : previewLength) + '...';
        }
        lessonContentPreview.textContent = previewText;

        lessonContainer.appendChild(lessonTitle);
        lessonContainer.appendChild(lessonContentPreview);
        resultDiv.appendChild(lessonContainer);
    });
}

// H√†m ti·ªán √≠ch ƒë·ªÉ hi·ªÉn th·ªã HTML an to√†n trong <pre> ho·∫∑c khi debug
function escapeHtml(text) {
    if (typeof text !== 'string') {
        text = String(text); // ƒê·∫£m b·∫£o ƒë·∫ßu v√†o l√† chu·ªói
    }
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

/**
 * H√†m l√†m s·∫°ch chu·ªói JSON.
 * C·ªë g·∫Øng tr√≠ch xu·∫•t kh·ªëi JSON h·ª£p l·ªá nh·∫•t t·ª´ m·ªôt chu·ªói c√≥ th·ªÉ ch·ª©a vƒÉn b·∫£n th·ª´a.
 * N√≥ s·∫Ω t√¨m ki·∫øm kh·ªëi JSON b·∫Øt ƒë·∫ßu b·∫±ng '{' ho·∫∑c '[' v√† k·∫øt th√∫c b·∫±ng '}' ho·∫∑c ']'
 * v√† l·∫∑p ƒëi l·∫∑p l·∫°i vi·ªác c·∫Øt t·ª´ cu·ªëi chu·ªói ƒë·ªÉ t√¨m m·ªôt JSON h·ª£p l·ªá.
 * @param {string} rawText Chu·ªói ƒë·∫ßu v√†o t·ª´ API.
 * @returns {string} Chu·ªói JSON ƒë√£ ƒë∆∞·ª£c l√†m s·∫°ch v√† h·ª£p l·ªá, ho·∫∑c chu·ªói r·ªóng n·∫øu kh√¥ng t√¨m th·∫•y JSON h·ª£p l·ªá.
 */
function cleanJsonString(rawText) {
    // B∆∞·ªõc 1: Lo·∫°i b·ªè c√°c backtick bao quanh ```json v√† ```
    let processedText = rawText
        .replace(/^```json\s*/, '')
        .replace(/\s*```$/, '')
        .trim();

    // B∆∞·ªõc 2: T√¨m v·ªã tr√≠ c·ªßa d·∫•u ngo·∫∑c m·ªü ƒë·∫ßu ti√™n v√† d·∫•u ngo·∫∑c ƒë√≥ng cu·ªëi c√πng
    const firstBrace = processedText.indexOf('{');
    const firstBracket = processedText.indexOf('[');

    let startIndex = -1;
    if (firstBrace !== -1 && (firstBracket === -1 || firstBrace < firstBracket)) {
        startIndex = firstBrace; // B·∫Øt ƒë·∫ßu b·∫±ng {
    } else if (firstBracket !== -1) {
        startIndex = firstBracket; // B·∫Øt ƒë·∫ßu b·∫±ng [
    }

    if (startIndex === -1) {
        console.warn("cleanJsonString: Kh√¥ng t√¨m th·∫•y d·∫•u ngo·∫∑c m·ªü JSON.");
        return ''; // Kh√¥ng t√¨m th·∫•y b·∫•t k·ª≥ d·∫•u ngo·∫∑c m·ªü n√†o
    }

    // C·∫Øt chu·ªói t·ª´ d·∫•u ngo·∫∑c m·ªü ƒë·∫ßu ti√™n
    let potentialJson = processedText.substring(startIndex);

    // B∆∞·ªõc 3: L·∫∑p l·∫°i vi·ªác c·∫Øt t·ª´ cu·ªëi v√† th·ª≠ parse cho ƒë·∫øn khi t√¨m ƒë∆∞·ª£c JSON h·ª£p l·ªá
    // Gi·ªõi h·∫°n s·ªë l·∫ßn th·ª≠ ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n n·∫øu d·ªØ li·ªáu qu√° t·ªá
    const maxAttempts = 100; // C√≥ th·ªÉ ƒëi·ªÅu ch·ªânh
    for (let i = 0; i < maxAttempts; i++) {
        try {
            // Th·ª≠ parse
            const parsed = JSON.parse(potentialJson);
            // N·∫øu parse th√†nh c√¥ng, stringify l·∫°i ƒë·ªÉ chu·∫©n h√≥a v√† tr·∫£ v·ªÅ
            return JSON.stringify(parsed);
        } catch (e) {
            // N·∫øu parse th·∫•t b·∫°i, c√≥ th·ªÉ l√† l·ªói "Unterminated string"
            // ho·∫∑c k√Ω t·ª± th·ª´a ·ªü cu·ªëi. C·∫Øt b·ªõt t·ª´ cu·ªëi chu·ªói.
            // C·∫Øt t·ª´ v·ªã tr√≠ cu·ªëi c√πng c·ªßa chu·ªói, b·ªè ƒëi 1 k√Ω t·ª±
            // N·∫øu chu·ªói qu√° ng·∫Øn, d·ª´ng l·∫°i
            if (potentialJson.length <= 1) {
                console.warn("cleanJsonString: Chu·ªói JSON ti·ªÅm nƒÉng qu√° ng·∫Øn, kh√¥ng th·ªÉ s·ª≠a l·ªói.");
                break;
            }

            // T√¨m d·∫•u ngo·∫∑c ƒë√≥ng cu·ªëi c√πng ƒë·ªÉ c·∫Øt. ∆Øu ti√™n c·∫Øt b·ªè c√°c k√Ω t·ª± kh√¥ng ph·∫£i JSON
            const lastChar = potentialJson[potentialJson.length - 1];
            if (lastChar === '}' || lastChar === ']') {
                 // N·∫øu k√Ω t·ª± cu·ªëi c√πng l√† d·∫•u ƒë√≥ng, th·ª≠ c·∫Øt ƒëi c√°c kho·∫£ng tr·∫Øng ho·∫∑c k√Ω t·ª± kh√¥ng ph·∫£i JSON
                potentialJson = potentialJson.slice(0, -1).trim();
                // Sau khi c·∫Øt ƒëi d·∫•u ƒë√≥ng, c√≥ th·ªÉ c·∫ßn th√™m l·∫°i n·∫øu n√≥ l√† d·∫•u ƒë√≥ng h·ª£p l·ªá
                // Logic n√†y ph·ª©c t·∫°p, c√°ch ƒë∆°n gi·∫£n h∆°n l√† ch·ªâ c·∫Øt b·ªõt t·ª´ng k√Ω t·ª±
            } else {
                 potentialJson = potentialJson.slice(0, -1); // C·∫Øt t·ª´ng k√Ω t·ª± t·ª´ cu·ªëi
            }
        }
    }

    console.error("cleanJsonString: Kh√¥ng th·ªÉ t√¨m th·∫•y JSON h·ª£p l·ªá sau nhi·ªÅu l·∫ßn th·ª≠.");
    return ''; // Tr·∫£ v·ªÅ chu·ªói r·ªóng n·∫øu kh√¥ng th·ªÉ l√†m s·∫°ch th√†nh c√¥ng
}


// --- Ch·ª©c nƒÉng Modal (H·ªôp tho·∫°i) ---
const lessonModal = document.getElementById('lessonModal');
const modalTitle = document.getElementById('modalTitle');
const modalContent = document.getElementById('modalContent');
const closeModalBtn = document.querySelector('.close-button'); // L·∫•y n√∫t ƒë√≥ng modal

function openLessonModal(title, content) {
    modalTitle.textContent = title;
    // S·ª≠ d·ª•ng innerHTML v√¨ n·ªôi dung t·ª´ AI c√≥ th·ªÉ ch·ª©a ƒë·ªãnh d·∫°ng nh∆∞ <pre> ho·∫∑c c√°c th·∫ª kh√°c.
    // **L∆ØU √ù B·∫¢O M·∫¨T**: N·∫øu ngu·ªìn n·ªôi dung kh√¥ng ƒë√°ng tin c·∫≠y, b·∫°n c·∫ßn l√†m s·∫°ch ho·∫∑c
    // s·ª≠ d·ª•ng th∆∞ vi·ªán Markdown parser ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n XSS.
    // Hi·ªán t·∫°i, ch√∫ng ta thay th·∫ø ng·∫Øt d√≤ng b·∫±ng <br> ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng.
    modalContent.innerHTML = content.replace(/\n/g, '<br>');

    lessonModal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // NgƒÉn cu·ªôn trang ch√≠nh
    modalTitle.focus(); // T·∫≠p trung v√†o ti√™u ƒë·ªÅ modal ƒë·ªÉ c·∫£i thi·ªán tr·∫£i nghi·ªám ng∆∞·ªùi d√πng
}

function closeModal() {
    lessonModal.style.display = 'none';
    document.body.style.overflow = ''; // Cho ph√©p cu·ªôn trang ch√≠nh tr·ªü l·∫°i
}

// ƒê√≥ng modal khi click v√†o n√∫t ƒë√≥ng
if (closeModalBtn) {
    closeModalBtn.onclick = closeModal;
}

// ƒê√≥ng modal khi click ra ngo√†i n·ªôi dung modal
window.onclick = function(event) {
    if (event.target === lessonModal) {
        closeModal();
    }
};

// ƒê√≥ng modal b·∫±ng ph√≠m Escape
document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && lessonModal.style.display === 'block') {
        closeModal();
    }
});
  </script>
</body>
</html>
